# Промежуточное программное обеспечение для маршрутов

Flight поддерживает маршруты и промежуточное программное обеспечение для групп маршрутов. Промежуточное программное обеспечение - это функция, которая выполняется перед (или после) обратного вызова маршрута. Это отличный способ добавить проверку аутентификации API в ваш код или проверить, есть ли у пользователя разрешение на доступ к маршруту.

## Основное промежуточное программное обеспечение

Вот простой пример:

```php
// Если вы предоставляете только анонимную функцию, она будет выполнена перед обратным вызовом маршрута. 
// кроме классов нет функций "после" промежуточного программного обеспечения (см. ниже)
Flight::route('/путь', function() { echo ' Вот я!'; })->addMiddleware(function() {
	echo 'Промежуточное программное обеспечение в первую очередь!';
});

Flight::start();

// Это выведет "Промежуточное программное обеспечение в первую очередь! Вот я!"
```

Есть несколько очень важных замечаний о промежуточном программном обеспечении, о которых вам следует знать перед использованием:
- Функции промежуточного программного обеспечения выполняются в порядке добавления к маршруту. Выполнение подобно тому, как это делает [Slim Framework](https://www.slimframework.com/docs/v4/concepts/middleware.html#how-does-middleware-work).
   - Предварительные функции выполняются в порядке их добавления, а постфункции выполняются в обратном порядке.
- Если ваша функция промежуточного программного обеспечения возвращает false, все выполнение останавливается, и генерируется ошибка 403 Forbidden. Вероятно, вам захочется более грациозно обработать это с помощью `Flight::redirect()` или чего-то подобного.
- Если вам нужны параметры из вашего маршрута, они будут передаваться в виде одного массива в вашу функцию промежуточного программного обеспечения. (`function($params) { ... }` или `public function before($params) {}`). Причина в том, что вы можете структурировать свои параметры в группы, и в некоторых из этих групп ваши параметры могут фактически появиться в другом порядке, что приведет к нарушению функции промежуточного программного обеспечения путем ссылки на неправильный параметр. Таким образом, вы можете получить к ним доступ по имени вместо позиции.

## Классы промежуточного программного обеспечения

Промежуточное программное обеспечение также может быть зарегистрировано как класс. Если вам нужна функциональность "после", вы **должны** использовать класс.

```php
class МоеПромежуточное {
	public function before($params) {
		echo 'Промежуточное программное обеспечение в первую очередь!';
	}

	public function after($params) {
		echo 'Последнее промежуточное программное обеспечение!';
	}
}

$МоеПромежуточное = new МоеПромежуточное();
Flight::route('/путь', function() { echo ' Вот я! '; })->addMiddleware($МоеПромежуточное); // также ->addMiddleware([ $МоеПромежуточное, $MоеПромежуточное2 ]);

Flight::start();

// Это выведет "Промежуточное программное обеспечение в первую очередь! Вот я! Последнее промежуточное программное обеспечение!"
```

## Группировка промежуточного программного обеспечения

Вы можете добавить группу маршрутов, и тогда каждый маршрут в этой группе также будет иметь то же промежуточное программное обеспечение. Это полезно, если вам нужно сгруппировать несколько маршрутов, скажем, с помощью промежуточного программного обеспечения для проверки ключа API в заголовке.

```php

// добавлено в конце метода group
Flight::group('/api', function() {

	// Этот "пустой" маршрут на самом деле совпадет с /api
	Flight::route('', function() { echo 'api'; }, false, 'api');
    Flight::route('/users', function() { echo 'users'; }, false, 'users');
	Flight::route('/users/@id', function($id) { echo 'user:'.$id; }, false, 'user_view');
}, [ new ПромежуточноеПрограммноеОбеспечениеApi() ]);
```

Если вы хотите применить общее промежуточное программное обеспечение ко всем своим маршрутам, вы можете добавить "пустую" группу:

```php

// добавлено в конце метода group
Flight::group('', function() {
	Flight::route('/users', function() { echo 'users'; }, false, 'users');
	Flight::route('/users/@id', function($id) { echo 'user:'.$id; }, false, 'user_view');
}, [ new ПромежуточноеПрограммноеОбеспечениеApi() ]);
```