# Промежуточное программное обеспечение маршрута

Flight поддерживает промежуточное программное обеспечение для маршрутов и групповых маршрутов. Промежуточное программное обеспечение представляет собой функцию, которая выполняется перед (или после) обратного вызова маршрута. Это отличный способ добавить проверки аутентификации API в ваш код или проверить, имеет ли пользователь разрешение на доступ к маршруту.

## Базовое промежуточное программное обеспечение

Вот простой пример:

```php
// Если вы предоставляете только анонимную функцию, она будет выполнена перед обратным вызовом маршрута.
// (см. ниже отсутствует функция "после")
Flight::route('/path', function() { echo 'Вот я!'; })->addMiddleware(function() {
	echo 'Сначала промежуточное программное обеспечение!';
});

Flight::start();

// Это выведет "Сначала промежуточное программное обеспечение! Вот я!"
```

Есть несколько очень важных замечаний о промежуточном программном обеспечении, о которых вы должны знать, прежде чем использовать его:
- Функции промежуточного программного обеспечения выполняются в порядке добавления к маршруту. Выполнение аналогично тому, как это обрабатывается в [Slim Framework](https://www.slimframework.com/docs/v4/concepts/middleware.html#how-does-middleware-work).
   - Функции перед выполнения обрабатываются в порядке добавления, а функции после выполнения - в обратном порядке.
- Если ваша функция промежуточного программного обеспечения возвращает false, выполнение останавливается, и генерируется ошибка 403 Forbidden. Возможно, вам захочется обработать это более гибко с помощью `Flight::redirect()` или чего-то подобного.
- Если вам нужны параметры из вашего маршрута, они будут передаваться в виде единого массива в вашу функцию промежуточного программного обеспечения. (`function($params) { ... }` или `public function before($params) {}`). Причина в том, что вы можете структурировать свои параметры в группы, и в некоторых из этих групп ваши параметры могут на самом деле появиться в другом порядке, что приведет к нарушению функции промежуточного программного обеспечения, обращаясь к неправильному параметру. Таким образом, вы можете получить к ним доступ по имени, а не по позиции.

## Классы промежуточного программного обеспечения

Промежуточное программное обеспечение можно зарегистрировать также как класс. Если вам нужна функциональность "после", **вам необходимо** использовать класс.

```php
class MyMiddleware {
	public function before($params) {
		echo 'Сначала промежуточное программное обеспечение!';
	}

	public function after($params) {
		echo 'Последнее промежуточное программное обеспечение!';
	}
}

$MyMiddleware = new MyMiddleware();
Flight::route('/path', function() { echo 'Вот я! '; })->addMiddleware($MyMiddleware); // также ->addMiddleware([ $MyMiddleware, $MyMiddleware2 ]);

Flight::start();

// Здесь будет отображено "Сначала промежуточное программное обеспечение! Вот я! Последнее промежуточное программное обеспечение!"
```

## Группировка промежуточного программного обеспечения

Вы можете добавить группу маршрутов, и затем каждый маршрут в этой группе также будет иметь одно и то же промежуточное программное обеспечение. Это полезно, если вам нужно сгруппировать множество маршрутов, например, по промежуточному программному обеспечению Auth для проверки ключа API в заголовке.

```php

// добавлено в конце метода группы
Flight::group('/api', function() {

	// Этот "пустой" маршрут будет фактически соответствовать /api
	Flight::route('', function() { echo 'api'; }, false, 'api');
    Flight::route('/users', function() { echo 'users'; }, false, 'users');
	Flight::route('/users/@id', function($id) { echo 'пользователь:'.$id; }, false, 'user_view');
}, [ new ApiAuthMiddleware() ]);
```

Если вы хотите применить общее промежуточное программное обеспечение ко всем вашим маршрутам, вы можете добавить "пустую" группу:

```php

// добавлено в конце метода группы
Flight::group('', function() {
	Flight::route('/users', function() { echo 'users'; }, false, 'users');
	Flight::route('/users/@id', function($id) { echo 'пользователь:'.$id; }, false, 'user_view');
}, [ new ApiAuthMiddleware() ]);
```