# Безопасность

Безопасность - это серьезное дело, когда речь идет о веб-приложениях. Вы хотите быть уверены, что ваше приложение защищено, и данные ваших пользователей в безопасности. Flight предоставляет ряд функций, чтобы помочь вам обеспечить безопасность ваших веб-приложений.

## Межсайтовая подделка запроса (CSRF)

Межсайтовая подделка запроса (CSRF) - это тип атаки, при которой зловредный сайт может заставить браузер пользователя отправить запрос на ваш сайт. Это можно использовать для выполнения действий на вашем сайте без ведома пользователя. Flight не предоставляет встроенного механизма защиты от CSRF, но его легко реализовать, используя промежуточное программное обеспечение.

Вот пример того, как можно реализовать защиту от CSRF с использованием фильтров событий:

```php

// Это промежуточное программное обеспечение проверяет, является ли запрос POST-запросом, и если является, проверяет, действителен ли маркер CSRF
Flight::before('start', function() {
	if(Flight::request()->method == 'POST') {

		// захватить маркер csrf из значений формы
		$token = Flight::request()->data->csrf_token;
		if($token != $_SESSION['csrf_token']) {
			Flight::halt(403, 'Недопустимый маркер CSRF');
		}
	}
});
```

## Межсайтовый скриптинг (XSS)

Межсайтовый скриптинг (XSS) - это тип атаки, при которой зловредный сайт может внедрить код на вашем сайте. Большинство таких возможностей появляются из значений форм, которые введут ваши пользователи. Никогда **не** доверяйте вводу от ваших пользователей! Всегда предполагайте, что все они - лучшие хакеры в мире. Они могут внедрить вредоносный JavaScript или HTML на вашу страницу. Этот код может использоваться для кражи информации ваших пользователей или выполнения действий на вашем сайте. Используя класс представления Flight, вы легко можете экранировать вывод, чтобы предотвратить атаки XSS.

```php

// Предположим, что пользователь хитрый и пытается использовать это в качестве своего имени
$name = '<script>alert("XSS")</script>';

// Это экранирует вывод
Flight::view()->set('name', $name);
// Это будет выведено: &lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;

// Если вы используете что-то подобное Latte зарегистрированное в качестве вашего класса представления, оно также автоматически экранирует это.
Flight::view()->render('шаблон', ['name' => $name]);
```

## SQL-инъекция

SQL-инъекция - это тип атаки, при которой зловредный пользователь может внедрить SQL-код в вашу базу данных. Это можно использовать для кражи информации из вашей базы данных или выполнения действий в вашей базе данных. Снова **никогда** не доверяйте вводу от ваших пользователей! Всегда предполагайте, что они ищут крови. Вы можете использовать подготовленные операторы в ваших объектах `PDO`, чтобы предотвратить SQL-инъекцию.

```php

// Предположим, что у вас зарегистрировано Flight::db() как ваш объект PDO
$statement = Flight::db()->prepare('SELECT * FROM users WHERE username = :username');
$statement->execute([':username' => $username]);
$users = $statement->fetchAll();

// Если вы используете класс PdoWrapper, это легко можно сделать одной строкой
$users = Flight::db()->fetchAll('SELECT * FROM users WHERE username = :username', [ 'username' => $username ]);

// То же самое можно сделать с объектом PDO из ? заполнителей
$statement = Flight::db()->fetchAll('SELECT * FROM users WHERE username = ?', [ $username ]);

// Просто обещайте никогда, но никогда НИЧЕГО не делать похожего на это...
$users = Flight::db()->fetchAll("SELECT * FROM users WHERE username = '{$username}'");
// потому что что, если $username = "' OR 1=1;"; После построения запроса выглядит
// вот так
// SELECT * FROM users WHERE username = '' OR 1=1;
// Выглядит странно, но это допустимый запрос, который будет работать. Фактически,
// это очень распространенная атака SQL-инъекции, которая вернет всех пользователей.
```

## CORS

Обмен ресурсами между разными источниками (CORS) - это механизм, позволяющий запросить множество ресурсов (например, шрифты, JavaScript и т. д.) на веб-странице с другого домена, отличного от домена, из которого ресурс был получен. У Flight нет встроенной функциональности, но это легко можно управлять с помощью промежуточного программного обеспечения или фильтров событий, аналогично CSRF.

```php

Flight::route('/users', function() {
	$users = Flight::db()->fetchAll('SELECT * FROM users');
	Flight::json($users);
})->addMiddleware(function() {
	if (isset($_SERVER['HTTP_ORIGIN'])) {
		header("Access-Control-Allow-Origin: {$_SERVER['HTTP_ORIGIN']}");
		header('Access-Control-Allow-Credentials: true');
		header('Access-Control-Max-Age: 86400');
	}

	if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
		if (isset($_SERVER['HTTP_ACCESS_CONTROL_REQUEST_METHOD'])) {
			header(
				'Access-Control-Allow-Methods: GET, POST, PUT, DELETE, PATCH, OPTIONS'
			);
		}
		if (isset($_SERVER['HTTP_ACCESS_CONTROL_REQUEST_HEADERS'])) {
			header(
				"Access-Control-Allow-Headers: {$_SERVER['HTTP_ACCESS_CONTROL_REQUEST_HEADERS']}"
			);
		}
		exit(0);
	}
});
```

## Заключение

Безопасность - это серьезное дело, и важно убедиться, что ваши веб-приложения защищены. Flight предоставляет ряд функций для помощи в обеспечении безопасности ваших веб-приложений, но важно всегда быть бдительным и делать все возможное для сохранения безопасности данных ваших пользователей. Всегда предполагайте худшее и никогда не доверяйте вводу от ваших пользователей. Всегда экранируйте вывод и используйте подготовленные операторы для предотвращения SQL-инъекций. Всегда используйте промежуточные программные средства для защиты ваших маршрутов от атак CSRF и CORS. Если вы все это делаете, вы будете на верном пути к созданию безопасных веб-приложений.