# Переход на v3

Совместимость с предыдущими версиями в целом была сохранена, но есть некоторые изменения, о которых вам следует знать при переходе с v2 на v3.

## Буферизация вывода

[Буферизация вывода](https://stackoverflow.com/questions/2832010/what-is-output-buffering-in-php) - это процесс, при котором вывод, сгенерированный скриптом PHP, хранится в буфере (внутри PHP) перед отправкой клиенту. Это позволяет вам изменять вывод перед его отправкой клиенту.

В приложении MVC Контроллер является "менеджером" и управляет поведением представления. Генерация вывода вне контроллера (или в случае Flight иногда анонимной функции) нарушает шаблон MVC. Это изменение призвано более точно соответствовать шаблону MVC и делать работу с фреймворком более предсказуемой и удобной.

В v2 буферизация вывода обрабатывалась таким образом, что не всегда правильно закрывался собственный буфер вывода, что делало [юнит-тестирование](https://github.com/flightphp/core/pull/545/files#diff-eb93da0a3473574fba94c3c4160ce68e20028e30b267875ab0792ade0b0539a0R42) и [потоковую передачу данных](https://github.com/flightphp/core/issues/413) более сложными. Для большинства пользователей это изменение на самом деле может вас не затронуть. Однако, если вы выводите содержимое вне вызываемых функций и контроллеров (например, в хуке), у вас могут возникнуть проблемы. Вывод содержимого в хуках и до фактического выполнения фреймворка в прошлом мог работать, но не будет работать в будущем.

### Где могут возникнуть проблемы
```php
// index.php
require 'vendor/autoload.php';

// just an example
define('START_TIME', microtime(true));

function hello() {
	echo 'Hello World';
}

Flight::map('hello', 'hello');
Flight::after('hello', function(){
	// this will actually be fine
	echo '<p>Эта фраза Hello World предоставлена буквой "H"</p>';
});

Flight::before('start', function(){
	// такие вещи вызовут ошибку
	echo '<html><head><title>Моя страница</title></head><body>';
});

Flight::route('/', function(){
	// это на самом деле нормально
	echo 'Hello World';

	// Это тоже должно быть в порядке
	Flight::hello();
});

Flight::after('start', function(){
	// это вызовет ошибку
	echo '<div>Ваша страница загружена за '.(microtime(true) - START_TIME).' секунд</div></body></html>';
});
```

### Включение поведения рендеринга v2

Можете ли вы оставить ваш старый код таким, как он есть, не переписывая его для работы с v3? Да, можете! Можно включить поведение рендеринга v2, установив опцию конфигурации `flight.v2.output_buffering` в значение `true`. Это позволит вам продолжать использовать старое поведение рендеринга, но рекомендуется исправить это в будущем. В v4 фреймворка это будет удалено.

```php
// index.php
require 'vendor/autoload.php';

Flight::set('flight.v2.output_buffering', true);

Flight::before('start', function(){
	// Теперь это будет в порядке
	echo '<html><head><title>Моя страница</title></head><body>';
});

// more code 
```